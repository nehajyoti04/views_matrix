<?php
/**
 * @file
 *   Views Matrix module file.
 */
use Drupal\Component\Utility\Html;
use Drupal\Core\Template\Attribute;

/**
 * Preprocess function for views-view-matrix.html.twig
 */
function views_matrix_preprocess_views_view_matrix(&$variables) {
  $variables['header'] = [];


//  kint($variables['view']->storage->id());
  $view = $variables['view'];
  $items = $variables['rows'];
  $variables['rows'] = '';
  $style = $view->style_plugin;
  $options = $style->options;
  $fields = $view->field;
  $xfield_id = $options['xconfig']['field'];
  $yfield_id = $options['yconfig']['field'];
  $xfield = &$fields[$xfield_id];
  $yfield = &$fields[$yfield_id];
  $columns = [];
  $columns_renders = [];

  $first_column_header = $options['xconfig']['first_column'];

  // Add rows default and custom CSS classes.
  $variables['default_row_class'] = !empty($options['default_row_class']);
  foreach ($items as $id => $item) {
    $xvalue = $variables['view']->style_plugin->getField($id, $xfield_id);
    $yvalue = $variables['view']->style_plugin->getField($id, $yfield_id);

    if (!in_array($xvalue, $columns)) {
      $columns[$id] = $xvalue;
      $columns_renders[$id] = $xvalue;
    }

    if ($first_column_header) {
      $variables['header'][] = array(
        '#markup' => $first_column_header,
        'attributes' => array(
          'class' => array(
            'views-matrix-col-header',
            'views-matrix-col-first',
          ),
        ),
      );
    }


//    $variables['rows'][$id] = [];
//    $variables['rows'][$id]['content'] = $item;

//    kint($id);
    $field_name = 'field_state';
    // kint($variables['view']->style_plugin->getField($id, $field_name));





//    $variables['rows'][$id]['content'] = $item;

    $variables['rows'][$id][] = $item;
//    $variables['rows'][$id][] = ['#markup' => $item];
//    $variables['rows'][$id][] = ['#markup' => 'hello'];

  }

  foreach ($columns_renders as $xindex => $col_render) {
    $variables['header'][] = array(
      '#markup' => $col_render,
      'attributes' => array(
        'class' => array(
          'views-matrix-col-header',
          'views-matrix-col-first',
        ),
      ),
    );
  }

  // Display content in a Masonry layout
//  $item_selector = '.masonry-item';
//  \Drupal::service('masonry.service')->applyMasonryDisplay($variables, $container, $item_selector, $options);
}

//function template_preprocess_views_view_matrix(&$variables) {
//}
